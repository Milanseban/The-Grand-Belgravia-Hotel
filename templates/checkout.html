<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - The Grand Belgravia</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Raleway:wght@300;400;500&display=swap');
        body{margin:0;font-family:'Raleway',sans-serif;background-color:#f4f4f4;color:#333;line-height:1.6;font-weight:300;}
        h1,h2,h3,h4{font-family:'Playfair+Display',serif;color:#1a2938;font-weight:700}
        .container{max-width:1100px;margin:auto;padding:0 20px}
        .navbar{background:rgba(255,255,255,0.9);padding:1.5rem 2rem;position:sticky;top:0;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center}
        .navbar .logo{font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:700;color:#1a2938;text-decoration:none}
        .navbar nav{display:flex;align-items:center}
        .navbar nav a{color:#333;text-decoration:none;margin:0 15px;font-weight:400;transition:color 0.3s}
        .navbar nav a:hover{color:#c9a96d}
        .navbar .nav-buttons {display:flex;align-items:center;gap:1rem}
        .navbar .cta-button{border:1px solid #c9a96d;padding:10px 20px;color:#c9a96d;text-decoration:none;transition:background-color 0.3s,color 0.3s;border-radius:5px}
        .navbar .cta-button:hover{background-color:#c9a96d;color:#fff}
        .navbar .login-button, .navbar .account-link {
            background:none;
            border:none;
            color:#333;
            font-family:'Raleway',sans-serif;
            font-size:1rem;
            font-weight:500;
            cursor:pointer;
            padding:10px 15px;
            text-decoration:none;
            transition:color 0.3s;
        }
        .navbar .login-button:hover, .navbar .account-link:hover {color:#c9a96d}
        .checkout-container{padding:4rem 0}
        .checkout-layout{display:flex;gap:3rem;flex-wrap:wrap-reverse}
        .checkout-form{flex:2 1 600px}
        .checkout-summary{flex:1 1 300px}
        .form-section,.summary-box{background:#fff;padding:2.5rem;margin-bottom:2rem;box-shadow:0 5px 25px rgba(0,0,0,0.05);border-radius:5px}
        .form-section h2{margin-top:0;font-size:1.8rem;padding-bottom:1rem;border-bottom:1px solid #eee}
        .form-row{display:flex;gap:1.5rem}
        .form-group{flex:1;display:flex;flex-direction:column;margin-bottom:1.5rem}
        .form-group label{margin-bottom:0.5rem;font-weight:500;color:#555}
        .form-group input{padding:0.8rem;border:1px solid #ddd;border-radius:5px;font-size:1rem;font-family:'Raleway',sans-serif}
        .form-group .field-note{font-size:0.8rem;color:#999;margin-top:0.25rem}
        .summary-box h2{margin-top:0;font-size:1.8rem;padding-bottom:1rem;border-bottom:1px solid #eee}
        .summary-item{display:flex;justify-content:space-between;margin-bottom:1rem;font-size:1rem}
        .summary-total{display:flex;justify-content:space-between;margin-top:1.5rem;padding-top:1.5rem;border-top:2px solid #1a2938;font-size:1.3rem;font-weight:700}
        .button-complete-booking{background-color:#c9a96d;color:#fff;padding:1rem;text-decoration:none;font-size:1.1rem;font-weight:500;transition:background-color 0.3s;display:block;width:100%;border:none;border-radius:5px;cursor:pointer;text-align:center;margin-top:1rem}
        .button-complete-booking:hover{background-color:#b8985f}
    </style>
</head>
<body>
    <header class="navbar">
        <a href="/" class="logo">The Grand Belgravia</a>
        <nav>
            <a href="/#about">About</a>
            <a href="/rooms/">Rooms</a>
            <a href="/dining/">Dining</a>
            <a href="/spa/">Spa</a>
            <a href="/#contact">Contact</a>
        </nav>
        <div class="nav-buttons">
            <div id="user-actions"></div>
            <a href="/booking/" class="cta-button">Book Now</a>
        </div>
    </header>
    <main>
        <div class="checkout-container container">
            <div class="checkout-layout">
                <div class="checkout-form">
                    <form id="checkout-form">
                        <div class="form-section">
                            <h2>Guest Information</h2>
                            <div class="form-row">
                                <div class="form-group"><label for="first-name">First Name</label><input type="text" id="first-name" placeholder="John" required></div>
                                <div class="form-group"><label for="last-name">Last Name</label><input type="text" id="last-name" placeholder="Smith" required></div>
                            </div>
                            <div class="form-group"><label for="email">Email Address</label><input type="email" id="email" placeholder="john.smith@example.com" required></div>
                        </div>
                        <div class="form-section">
                            <h2>Payment Details</h2>
                            <div class="form-group"><label for="card-name">Name on Card</label><input type="text" id="card-name" placeholder="John H. Smith" required></div>
                            <div class="form-group"><label for="card-number">Card Number</label><input type="text" id="card-number" placeholder="1234 5678 1234 5678" required><small class="field-note">Demo only: Please enter any 16 digits.</small></div>
                            <div class="form-row">
                                <div class="form-group"><label for="expiry-date">Expiry Date</label><input type="text" id="expiry-date" placeholder="MM / YY" required></div>
                                <div class="form-group"><label for="cvc">CVC</label><input type="text" id="cvc" placeholder="123" required><small class="field-note">Enter any 3 digits.</small></div>
                            </div>
                        </div>
                        <button type="submit" class="button-complete-booking">Complete Booking</button>
                    </form>
                </div>
                <div class="checkout-summary">
                    <div class="summary-box">
                        <h2>Booking Summary</h2>
                        <div class="summary-item"><span>Check-in:</span><span id="summary-checkin"></span></div>
                        <div class="summary-item"><span>Check-out:</span><span id="summary-checkout"></span></div>
                        <div class="summary-item"><span>Guests:</span><span id="summary-guests"></span></div>
                        <div class="summary-item"><span>Room:</span><span id="summary-room"></span></div>
                        <div class="summary-total"><span>Total (GBP):</span><span id="summary-total-price"></span></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userActionsContainer = document.getElementById('user-actions');

            const getCookie = (name) => {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');

            const updateHeader = () => {
                if (localStorage.getItem('authToken')) {
                    userActionsContainer.innerHTML = `<a href="/account/" class="account-link">My Account</a>`;
                } else {
                    alert("Please log in to complete your booking.");
                    window.location.href = '/';
                }
            };
            updateHeader();

            const roomPrices = { 1: 450, 2: 650, 3: 850, 4: 950, 5: 2500 };
            const checkin = localStorage.getItem('checkinDate');
            const checkout = localStorage.getItem('checkoutDate');
            const adults = localStorage.getItem('adults');
            const children = localStorage.getItem('children');
            const roomId = localStorage.getItem('roomId');
            const roomTypeName = localStorage.getItem('roomTypeName');
            document.getElementById('summary-checkin').textContent = checkin || 'N/A';
            document.getElementById('summary-checkout').textContent = checkout || 'N/A';
            document.getElementById('summary-guests').textContent = `${adults || '0'} Adults, ${children || '0'} Children`;
            document.getElementById('summary-room').textContent = roomTypeName || 'N/A';
            const pricePerNight = roomPrices[roomId] || 0;
            document.getElementById('summary-total-price').textContent = `Â£${pricePerNight.toFixed(2)} / night`;

            document.getElementById('checkout-form').addEventListener('submit', function(event) {
                event.preventDefault();
                const firstName = document.getElementById('first-name').value;
                if (!firstName) {
                    alert('Please fill out all guest and payment fields.');
                    return;
                }

                const authToken = localStorage.getItem('authToken');
                const bookingData = {
                    room_id: parseInt(roomId), // Send the ID of the room
                    check_in_date: checkin,
                    check_out_date: checkout,
                    guests: parseInt(adults) + parseInt(children)
                };

                fetch('/api/bookings/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                        'Authorization': `Token ${authToken}`
                    },
                    body: JSON.stringify(bookingData)
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Booking failed. The selected room may no longer be available.');
                })
                .then(data => {
                    localStorage.setItem('firstName', firstName);
                    window.location.href = '/thank-you/';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error.message);
                });
            });
        });
    </script>
</body>
</html>